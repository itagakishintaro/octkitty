<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="get-metrics">
    <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    </style>

    <app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page/:owner/:repo"
        data="{{routeData}}"></app-route>

        <section class="card">
          <h1>Repository Metrics</h1>
          <table >
            <tr><th>Star</th><th>Watch</th><th>Fork</th><th>Last year Commits</th><th>Contributors</th><th>License</th></tr>
            <tr><td>[[star]]</td><td>[[watch]]</td><td>[[fork]]</td><td>[[commits1year]]</td><td>[[contributors]]</td><td>[[license]]</td></tr>
    </table>
    </section>
    </template>

    <script>
        class GetMetrics extends Polymer.Element {
            static get is() {
                return 'get-metrics';
            }

            constructor() {
                super();
                this.star = '-';
                this.watch = '-';
                this.fork = '-';
                this.commits1year = '-';
                this.contributors = '-';
                this.license = '-';
            }

            static get observers() {
                return [
                    '_paramChanged(routeData)'
                ]
            }

            static get properties() {
                return {
                    star: String,
                    watch: String,
                    fork: String,
                    commits1year: String,
                    contributors: String,
                    license: String,
                }
            }

            _paramChanged(d) {
                console.log(d);
                fetch(`https://api.github.com/repos/${d.owner}/${d.repo}`)
                    .then(res => {
                        return res.json();
                    })
                    .then(json => {
                        console.log(json);
                        this.set('star', json.stargazers_count);
                        this.set('watch', json.subscribers_count);
                        this.set('fork', json.forks_count);
                    })
                    .catch(error => {
                        console.error(error);
                    });

                fetch(`https://api.github.com/repos/${d.owner}/${d.repo}/stats/participation`)
                    .then(res => {
                        return res.json();
                    })
                    .then(json => {
                        console.log(json);
                        this.set('commits1year', json.all.reduce((pre, current) => {
                            return pre + current;
                        }));
                    });

                const string = '<https://api.github.com/repositories/24195339/contributors?per_page=1&page=2>; rel="next", <https://api.github.com/repositories/24195339/contributors?per_page=1&page=446>; rel="last"';
                const re = /(page=)(\d*)(>; rel="last")/g;
                const result = re.exec(string);
                console.log(result);

                fetch(`https://api.github.com/repos/${d.owner}/${d.repo}/contributors?per_page=1`, {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        method: 'GET'
                    })
                    .then(res => {
                        console.log(res.headers.get('Link'));
                        const re = /(page=)(\d*)(>; rel="last")/g;
                        const result = re.exec(res.headers.get('Link'));
                        this.set('contributors', result[2]);
                    });

                fetch(`https://api.github.com/repos/${d.owner}/${d.repo}/license`)
                    .then(res => {
                        return res.json();
                    })
                    .then(json => {
                        console.log(json);
                        this.set('license', json.license.name);
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }
        }

        window.customElements.define(GetMetrics.is, GetMetrics);
    </script>
</dom-module>
